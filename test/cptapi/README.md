# SST Checkpoint JSON Schema and Python3 API

## Overview
Using a TCL custom branch of sst-core, we can generate a structured representation of the checkpoint file that can be consumed by the Python json module and support user interaction via a simple API. There is no change to the way serialization is specified in a component design.

### SST Core

Important: Use the 'schema' branch from the sst-core-tcl repository.

    git clone git@github.com:tactcomplabs/sst-core.git
    cd sst-core
    git checkout schema
    ./autogen.sh
    mkdir build && cd build
    ../configure --prefix=<install-dir>
    make -j -s && make install

If running on MacOS you made need to configuration SST with the --disableMPI flag

### SST Tools

    git clone git@github.com:tactcomplabs/sst-tools.git
    cd build
    cmake -DSST_TOOLS_ENABLE_TESTING=ON -DSST_TOOLS_CLEAN_TESTS=OFF ..
    make -j -s && make install
    ctest -j 4

### Example schema and API test

If sst-core is set up properly then the schema test should run and pass.  Using -DSST_TOOL_CLEAN_TESTS=OFF ensures that the checkpoint directoriers are retained.

    Test project /Users/kgriesser/work/sst-tools/build
        Start 1: clidbg-sanity
    1/4 Test #1: clidbg-sanity ....................   Passed    2.10 sec
        Start 2: 2d_SAVE
    2/4 Test #2: 2d_SAVE ..........................   Passed    1.99 sec
        Start 3: 2d_RESTORE
    3/4 Test #3: 2d_RESTORE .......................   Passed    0.08 sec
        Start 4: SCHEMA_TEST
    4/4 Test #4: SCHEMA_TEST ......................   Passed    1.84 sec

To view example JSON files generated by the SCHEMA test:

    cd <sst-tools>/test/cptapi/SCHEMA_SAVE_/SCHEMA_SAVE__0_1000000
    ls *.json

There is one .json file associated with each .bin file. For convenience, the test also runs each json file through c++filt -t  to demangle type strings and saves the result in *.schema.json.

    SCHEMA_SAVE__0_1000000_0_0.json
    SCHEMA_SAVE__0_1000000_0_0.schema.json
    SCHEMA_SAVE__0_1000000_0_1.json
    SCHEMA_SAVE__0_1000000_0_1.schema.json
    SCHEMA_SAVE__0_1000000_0_2.json
    SCHEMA_SAVE__0_1000000_0_2.schema.json
    SCHEMA_SAVE__0_1000000_0_3.json
    SCHEMA_SAVE__0_1000000_0_3.schema.json
    SCHEMA_SAVE__0_1000000_globals.json
    SCHEMA_SAVE__0_1000000_globals.schema.json


## JSON Schema Example

The json data structure is organized into 'segments' which are based on the serialization sequence in sst-core.  Unique for the begin and end of sequence are added to allow checking the integrity of the serialized data. For each serailized object we save the name, positiong within a segment, and a hash_code representation of the object's type.  The last data structure maps this hash to the actual type name string. 

    { "checkpoint_def" : [
    {
    "rec_type" : "seg_info",
    "seg_name" : "loaded_libraries",
    "seg_num" : "0",
    "seg_size" : "47",
    "names" :
    [
    {"name" : "seg2begin" , "pos" : "8" , "hash_code" : "0x18a4354c1" },
    {"name" : "libnames" , "pos" : "16" , "hash_code" : "0xebdb811f14e14236" },
    {"name" : "seg2end" , "pos" : "39" , "hash_code" : "0x18a4354c1" }
    ]
    },
    {
    "rec_type" : "seg_info",
    "seg_name" : "simulation_impl",
    "seg_num" : "1",
    "seg_size" : "68035",
    "names" :
    [
    {"name" : "seg3begin" , "pos" : "8" , "hash_code" : "0x18a4354c1" },
    {"name" : "num_ranks" , "pos" : "16" , "hash_code" : "0xc0307525065dfd09" },
    {"name" : "my_rank" , "pos" : "24" , "hash_code" : "0xc0307525065dfd09" },
    {"name" : "currentSimCycle" , "pos" : "32" , "hash_code" : "0x18a4354c1" },
    {"name" : "minPart" , "pos" : "40" , "hash_code" : "0x18a4354c1" },
    {"name" : "minPartTC" , "pos" : "48" , "hash_code" : "0x4ae7def063f2b68e" },
    {"name" : "interThreadLatencies" , "pos" : "64" , "hash_code" : "0x957105207b4c5d9f" },
    {"name" : "interThreadMinLatency" , "pos" : "104" , "hash_code" : "0x18a4354c1" },
    {"name" : "endSim" , "pos" : "112" , "hash_code" : "0x18a435455" },
    {"name" : "independent" , "pos" : "116" , "hash_code" : "0x18a435455" },
    {"name" : "timeVortexType" , "pos" : "120" , "hash_code" : "0x61cff16e98e71d45" },
    {"name" : "runMode" , "pos" : "153" , "hash_code" : "0x4a759cb56414dd6" },
    {"name" : "currentPriority" , "pos" : "157" , "hash_code" : "0x18a435494" },
    {"name" : "endSimCycle" , "pos" : "161" , "hash_code" : "0x18a4354c1" },
    {"name" : "output_directory" , "pos" : "169" , "hash_code" : "0x61cff16e98e71d45" },
    {"name" : "real_time_" , "pos" : "217" , "hash_code" : "0x273db34d531fa441" },
    {"name" : "serial_exec_" , "pos" : "233" , "hash_code" : "0x18a435455" },
    {"name" : "m_heartbeat" , "pos" : "237" , "hash_code" : "0xe14ad24b49e9172e" },
    {"name" : "stat_engine" , "pos" : "245" , "hash_code" : "0x100a2c88a" },
    {"name" : "clockMap" , "pos" : "258" , "hash_code" : "0x1d57792d7d434285" },
    {"name" : "timeVortex" , "pos" : "354" , "hash_code" : "0x34f7dcc38da5ee0f" },
    {"name" : "data" , "pos" : "491" , "hash_code" : "0x198e238dcc8de27f" },
    ... omitted ...
    {"name" : "data" , "pos" : "67431" , "hash_code" : "0x198e238dcc8de27f" },
    {"name" : "seg3end" , "pos" : "68027" , "hash_code" : "0x18a4354c1" }
    ]
    },
    {
    "rec_type" : "seg_info",
    "seg_name" : "NUM_COMPONENTS",
    "seg_num" : "2",
    "seg_size" : "8",
    "names" :
    [
    {"name" : "NUM_COMPONENTS" , "pos" : "0" , "hash_code" : "0x18a43546c" }
    ]
    },
    {
    "rec_type" : "seg_info",
    "seg_name" : "cp_1_0",
    "seg_num" : "3",
    "seg_size" : "40882",
    "names" :
    [
    {"name" : "segcbegin" , "pos" : "8" , "hash_code" : "0x18a4354c1" },
    {"name" : "compinfo" , "pos" : "16" , "hash_code" : "0x68692f2dd002fc1a" },
    {"name" : "const_cast<ComponentId_t&>(id_)" , "pos" : "24" , "hash_code" : "0x18a4354c1" },
    {"name" : "parent_info" , "pos" : "32" , "hash_code" : "0x68692f2dd002fc1a" },
    {"name" : "const_cast<std::string&>(name)" , "pos" : "40" , "hash_code" : "0x61cff16e98e71d45" },
    {"name" : "const_cast<std::string&>(type)" , "pos" : "50" , "hash_code" : "0x61cff16e98e71d45" },
    {"name" : "defaultTimeBase" , "pos" : "67" , "hash_code" : "0x4ae7def063f2b68e" },
    {"name" : "subIDIndex" , "pos" : "83" , "hash_code" : "0x18a4354c1" },
    {"name" : "const_cast<std::string&>(slot_name)" , "pos" : "91" , "hash_code" : "0x61cff16e98e71d45" },
    {"name" : "slot_num" , "pos" : "101" , "hash_code" : "0x18a435494" },
    ... omitted ...
    {"name" : "dataMask" , "pos" : "40690" , "hash_code" : "0x18a4354c1" },
    {"name" : "dataMax" , "pos" : "40698" , "hash_code" : "0x18a4354c1" },
    {"name" : "cptEnd" , "pos" : "40706" , "hash_code" : "0x18a4354c1" },
    {"name" : "link_map" , "pos" : "40714" , "hash_code" : "0x5b5750b6b57d9fd2" },
    {"name" : "segcend" , "pos" : "40874" , "hash_code" : "0x18a4354c1" }
    ]
    },
    {
    "rec_type" : "type_info",
    "type_info": [
    {"hash_code" : "0x100a2c88a" , "name" : "SST::Statistics::StatisticProcessingEngine" , "size" : "400" },
    {"hash_code" : "0x18a435455" , "name" : "bool" , "size" : "1" },
    {"hash_code" : "0x18a43546c" , "name" : "char const*" , "size" : "8" },
    {"hash_code" : "0x18a435494" , "name" : "int" , "size" : "4" },
    {"hash_code" : "0x18a43549d" , "name" : "unsigned int" , "size" : "4" },
    {"hash_code" : "0x18a4354af" , "name" : "unsigned long" , "size" : "8" },
    {"hash_code" : "0x18a4354c1" , "name" : "unsigned long long" , "size" : "8" },
    {"hash_code" : "0x4a759cb56414dd6" , "name" : "SST::SimulationRunMode" , "size" : "4" },
    {"hash_code" : "0x573911d5090ac88" , "name" : "std::__1::vector<SST::Link*, 
    ... omitted ...
    {"hash_code" : "0xebdb811f14e14236" , "name" : "std::__1::set<std::__1::basic_string<char, std::__1::char_traits<char>, std::__1::allocator<char>>, std::__1::less<std::__1::basic_string<char, std::__1::char_traits<char>, std::__1::allocator<char>>>, std::__1::allocator<std::__1::basic_string<char, std::__1::char_traits<char>, std::__1::allocator<char>>>>" , "size" : "24" }
    ]
    }
    ]}

## Python3 API Example

The current API is defined in <sst-tools>/scripts/cptapi.py

Add to PYTYHONPATH:

    export PYTHONPATH="<sst-tools/scripts>:$PYTHONPATH"
         
Python3 usage:

    import cptapi
    cptObj = cptapi.CPT()
    cptObj.load(path-to-json-file)
    pos = cptObj.getPosition(hierarchical-variable-name)
    type = cptObj.getType(hierarchical-variable-name)
    value = cptObj.getValue(hierarchical-variable-name)


See schema-test.sh and cpt_verify.py for a working example. 